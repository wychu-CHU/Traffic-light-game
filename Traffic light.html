<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遊戲五：擦擦紅綠燈 (V4 加大版)</title>
    <style>
        /* --- 全局設定 --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #222;
            font-family: "Microsoft JhengHei", sans-serif;
            overflow: hidden;
            user-select: none;
        }

        /* --- 1. 開始畫面 (選單) --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
        }

        h1 { font-size: 3em; margin-bottom: 40px; color: #00BFFF; }

        .menu-container { display: flex; gap: 30px; }
        .menu-btn {
            padding: 30px 40px;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            border: 4px solid #fff;
            color: #000;
            transition: transform 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 200px;
        }
        .menu-btn:active { transform: scale(0.95); }
        #btn-red { background-color: #FF4500; }
        #btn-green { background-color: #32CD32; }
        #btn-both { background-color: #FFD700; }

        /* --- 2. 遊戲區域 --- */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: none;
            /* 修改：改用 flex column 讓內容盡量佔滿，並往下推 */
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            background-color: #222;
        }

        /* 圖片與畫布的容器 */
        #canvas-wrapper {
            position: relative;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            border: 3px solid #555; /* 邊框改細一點 */
            background-color: #000;
            visibility: hidden; 
            /* 增加一個最小邊距，避免貼死螢幕邊緣 */
            margin: 10px;
        }

        #bg-image {
            display: block;
            width: 100%; 
            height: 100%;
            object-fit: contain;
        }

        #scratch-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
            cursor: crosshair;
            touch-action: none;
        }

        /* --- UI 介面 --- */
        #ui-layer {
            position: absolute;
            top: 10px; /* 往上移一點 */
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px; /* 邊距縮小 */
            box-sizing: border-box;
            z-index: 50;
            pointer-events: none;
        }

        .status-badge {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2em; /* 字體稍微縮小 */
            border: 1px solid #777;
        }
        #back-home-btn { pointer-events: auto; cursor: pointer; background: #333; }
        
        #success-btn {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
            background-color: #00BFFF;
            color: #000;
            border: 4px solid #fff;
            padding: 20px 50px;
            border-radius: 15px;
            box-shadow: 0 0 30px #00BFFF;
            font-size: 2em;
            font-weight: bold;
            pointer-events: auto;
            cursor: pointer;
            animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* 設定面板 */
        #settings-btn { pointer-events: auto; background: #333; cursor: pointer; }
        #settings-panel {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background-color: #222;
            padding: 30px;
            border: 4px solid #00BFFF;
            border-radius: 20px;
            width: 400px;
            z-index: 200;
            text-align: center;
            color: white;
        }
        
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>請選擇關卡</h1>
        <div class="menu-container">
            <button class="menu-btn" id="btn-red">找找<br>紅燈</button>
            <button class="menu-btn" id="btn-green">找找<br>綠燈</button>
            <button class="menu-btn" id="btn-both">找找<br>紅綠燈</button>
        </div>
        <p style="margin-top:40px; color:#aaa; font-size:1.2em;">註：請注視螢幕，擦去霧氣</p>
    </div>

    <div id="game-container">
        <div id="ui-layer">
            <div class="status-badge" id="back-home-btn">← 回選單</div>
            <div class="status-badge" id="settings-btn">⚙️ 設定</div>
        </div>

        <div id="canvas-wrapper">
            <img id="bg-image" src="" alt="Hidden Image">
            <canvas id="scratch-canvas"></canvas>
        </div>

        <button id="success-btn">好棒！回選單 ➜</button>
    </div>

    <div id="settings-panel">
        <h3>遊戲設定</h3>
        <div style="margin: 20px 0; text-align: left;">
            <label style="font-size:1.2em; display:block; margin-bottom:10px;">橡皮擦大小: <span id="val-size" style="float:right; color:#00BFFF">80</span></label>
            <input type="range" id="rng-size" min="30" max="150" value="80" style="width:100%; height:25px;">
        </div>
        <button class="btn" id="close-settings" style="font-size:1.5em; padding:10px 30px; border-radius:10px; cursor:pointer;">確定</button>
    </div>

    <script>
        const levels = [
            { id: 0, img: 'level1.jpg', sound: 'sound_red.mp3' },
            { id: 1, img: 'level2.jpg', sound: 'sound_green.mp3' },
            { id: 2, img: 'level3.jpg', sound: 'sound_both.mp3' }
        ];

        let currentLevel = null;
        let brushSize = 80;
        let clearedPercentage = 0;
        let levelCompleted = false;
        let currentAudio = null;

        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const canvas = document.getElementById('scratch-canvas');
        const ctx = canvas.getContext('2d');
        const bgImage = document.getElementById('bg-image');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const successBtn = document.getElementById('success-btn');
        const backHomeBtn = document.getElementById('back-home-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings');
        const rngSize = document.getElementById('rng-size');
        const valSize = document.getElementById('val-size');

        // --- 選單控制 ---
        document.getElementById('btn-red').addEventListener('click', () => { startGame(0); });
        document.getElementById('btn-green').addEventListener('click', () => { startGame(1); });
        document.getElementById('btn-both').addEventListener('click', () => { startGame(2); });

        function startGame(levelIndex) {
            startScreen.style.display = 'none';
            gameContainer.style.display = 'flex';
            currentLevel = levels[levelIndex];
            levelCompleted = false;
            successBtn.style.display = 'none';
            
            canvasWrapper.style.visibility = 'hidden';

            bgImage.src = currentLevel.img;
            
            if(currentAudio) { currentAudio.pause(); currentAudio = null; }
            currentAudio = new Audio(currentLevel.sound);

            bgImage.onload = () => {
                adjustGameSize();
                resetFog();
                canvasWrapper.style.visibility = 'visible';
            };
        }

        function goHome() {
            gameContainer.style.display = 'none';
            startScreen.style.display = 'flex';
            if(currentAudio) { currentAudio.pause(); }
        }

        backHomeBtn.addEventListener('click', goHome);
        successBtn.addEventListener('click', goHome);

        // --- 核心修改：加大畫布尺寸限制 ---
        function adjustGameSize() {
            // 修改點：將可用寬度加大到 98%，高度加大到 92%
            const maxWidth = window.innerWidth * 0.98;
            const maxHeight = window.innerHeight * 0.92;

            const imgW = bgImage.naturalWidth;
            const imgH = bgImage.naturalHeight;

            // 計算縮放比例，確保圖片完整顯示 (contain)
            const scale = Math.min(maxWidth / imgW, maxHeight / imgH);

            const newWidth = imgW * scale;
            const newHeight = imgH * scale;

            canvasWrapper.style.width = newWidth + 'px';
            canvasWrapper.style.height = newHeight + 'px';

            canvas.width = newWidth;
            canvas.height = newHeight;
        }

        window.addEventListener('resize', () => {
            if (gameContainer.style.display === 'flex') {
                adjustGameSize();
                if(!levelCompleted) resetFog();
            }
        });

        // --- 畫布邏輯 ---
        function resetFog() {
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = '#BBBBBB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 修改點：提示文字大小根據畫布高度自動調整，避免太小
            const fontSize = Math.max(30, Math.floor(canvas.height / 10));
            ctx.font = `bold ${fontSize}px Microsoft JhengHei`;
            ctx.fillStyle = "#555";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("請注視擦乾淨", canvas.width/2, canvas.height/2);
            
            ctx.globalCompositeOperation = 'destination-out';
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function scratch(e) {
            if (levelCompleted) return;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, brushSize, 0, Math.PI * 2);
            ctx.fill();
            if (Math.random() < 0.1) checkProgress();
        }

        canvas.addEventListener('mousemove', scratch);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); scratch(e); }, {passive: false});

        function checkProgress() {
            if (levelCompleted) return;
            const w = canvas.width;
            const h = canvas.height;
            const gap = 15;
            try {
                const imageData = ctx.getImageData(0, 0, w, h);
                const data = imageData.data;
                let total = 0, clear = 0;
                for (let y = 0; y < h; y += gap) {
                    for (let x = 0; x < w; x += gap) {
                        total++;
                        const index = (y * w + x) * 4;
                        if (data[index + 3] < 128) clear++;
                    }
                }
                if ((clear / total) * 100 > 70) levelSuccess();
            } catch(e) {
                console.log("Image Data Error:", e);
            }
        }

        function levelSuccess() {
            levelCompleted = true;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(currentAudio) {
                currentAudio.currentTime = 0;
                currentAudio.play().catch(e => console.log("Audio block"));
            }
            successBtn.style.display = 'block';
        }

        settingsBtn.addEventListener('click', () => { settingsPanel.style.display = 'block'; });
        closeSettingsBtn.addEventListener('click', () => { settingsPanel.style.display = 'none'; });
        rngSize.addEventListener('input', () => {
            brushSize = parseInt(rngSize.value);
            valSize.textContent = brushSize;
        });

    </script>
</body>
</html>